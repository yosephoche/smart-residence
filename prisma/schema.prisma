datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum Role {
  ADMIN
  USER
  STAFF
}

enum PaymentStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ExpenseCategory {
  MAINTENANCE
  SECURITY
  UTILITIES
  CLEANING
  LANDSCAPING
  ADMINISTRATION
  OTHER
}

enum IncomeCategory {
  MONTHLY_FEES
  LATE_FEES
  GUEST_PARKING
  FACILITY_RENTAL
  MAINTENANCE_CHARGE
  REGISTRATION_FEE
  OTHER
}

enum JobType {
  SECURITY
  CLEANING
  GARDENING
  MAINTENANCE
  OTHER
}

enum AttendanceType {
  CLOCK_IN
  CLOCK_OUT
}

enum ShiftReportType {
  SHIFT_START
  SHIFT_MIDDLE
  SHIFT_END
}

model User {
  id             String          @id @default(cuid())
  name           String
  email          String          @unique
  password       String
  role           Role            @default(USER)
  staffJobType   JobType?
  phone          String?
  address        String?
  isFirstLogin   Boolean         @default(true)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  houses         House[]
  payments       Payment[]
  approvedPayments Payment[]     @relation("ApprovedBy")
  expenses       Expense[]
  incomes        Income[]
  systemConfigUpdates SystemConfig[]
  attendances    Attendance[]
  shiftReports   ShiftReport[]
  staffSchedules       StaffSchedule[]
  createdSchedules     StaffSchedule[] @relation("ScheduleCreator")
}

model HouseType {
  id          String   @id @default(cuid())
  typeName    String
  price       Decimal
  description String?
  houses      House[]
}

model House {
  id          String     @id @default(cuid())
  houseNumber String
  block       String
  houseTypeId String
  userId     String?
  isRented    Boolean    @default(false)
  renterName  String?
  houseType   HouseType  @relation(fields: [houseTypeId], references: [id])
  user        User?      @relation(fields: [userId], references: [id])
  payments    Payment[]
}

model Payment {
  id             String        @id @default(cuid())
  userId        String
  houseId        String
  amountMonths   Int
  totalAmount    Decimal
  proofImagePath String
  status         PaymentStatus @default(PENDING)
  rejectionNote  String?
  approvedBy     String?
  approvedAt     DateTime?
  createdAt      DateTime      @default(now())
  user           User          @relation(fields: [userId], references: [id])
  house          House         @relation(fields: [houseId], references: [id])
  approver       User?         @relation("ApprovedBy", fields: [approvedBy], references: [id])
  paymentMonths  PaymentMonth[]
  income         Income?

  @@index([houseId, status])
}

model PaymentMonth {
  id        String  @id @default(cuid())
  paymentId String
  year      Int
  month     Int
  payment   Payment @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  @@unique([paymentId, year, month])
}

model Expense {
  id          String          @id @default(cuid())
  date        DateTime
  category    ExpenseCategory
  amount      Decimal
  description String
  notes       String?
  createdBy   String
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  creator     User            @relation(fields: [createdBy], references: [id])
}

model Income {
  id          String         @id @default(cuid())
  date        DateTime
  category    IncomeCategory
  amount      Decimal
  description String
  notes       String?
  createdBy   String
  paymentId   String?        @unique
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  creator     User           @relation(fields: [createdBy], references: [id])
  payment     Payment?       @relation(fields: [paymentId], references: [id])
}

model SystemConfig {
  id        String   @id @default(cuid())
  key       String   @unique
  value     Json
  updatedBy String
  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())
  updater   User     @relation(fields: [updatedBy], references: [id])

  @@index([key])
}

model Attendance {
  id              String    @id @default(cuid())
  staffId         String
  clockInAt       DateTime
  clockOutAt      DateTime?
  shiftStartTime  String
  scheduleId      String?
  lateMinutes     Int?

  // Clock IN data
  clockInLat      Float
  clockInLon      Float
  clockInPhoto    String

  // Clock OUT data (nullable)
  clockOutLat     Float?
  clockOutLon     Float?
  clockOutPhoto   String?

  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  staff           User       @relation(fields: [staffId], references: [id])
  schedule        StaffSchedule? @relation(fields: [scheduleId], references: [id], onDelete: SetNull)
  shiftReports    ShiftReport[]

  @@index([staffId, clockInAt])
  @@index([scheduleId])
}

model ShiftReport {
  id            String           @id @default(cuid())
  staffId       String
  attendanceId  String?
  reportType    ShiftReportType
  content       String
  photoUrl      String?
  reportedAt    DateTime         @default(now())

  staff         User             @relation(fields: [staffId], references: [id])
  attendance    Attendance?      @relation(fields: [attendanceId], references: [id], onDelete: SetNull)

  @@index([staffId, reportedAt])
}

model ShiftTemplate {
  id               String          @id @default(cuid())
  jobType          JobType
  shiftName        String
  startTime        String
  endTime          String
  toleranceMinutes Int             @default(15)
  requiredStaffCount Int           @default(1)
  isActive         Boolean         @default(true)
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  schedules        StaffSchedule[]

  @@unique([jobType, shiftName])
  @@index([jobType, isActive])
}

model StaffSchedule {
  id              String        @id @default(cuid())
  staffId         String
  shiftTemplateId String
  date            DateTime
  notes           String?
  createdBy       String
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  staff           User          @relation(fields: [staffId], references: [id])
  shiftTemplate   ShiftTemplate @relation(fields: [shiftTemplateId], references: [id])
  creator         User          @relation("ScheduleCreator", fields: [createdBy], references: [id])
  attendances     Attendance[]

  @@unique([staffId, shiftTemplateId, date])
  @@index([date, shiftTemplateId])
  @@index([staffId, date])
}
